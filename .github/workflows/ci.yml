name: CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:

# Cancel in-progress runs for the same workflow and branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Check code formatting
  format-check:
    name: Code Formatting
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.x'
        cache: true

    - name: Check formatting
      run: |
        if [ -n "$(gofmt -l .)" ]; then
          echo "The following files are not formatted:"
          gofmt -l .
          echo ""
          echo "Please run 'make fmt' or 'go fmt ./...' to fix formatting"
          exit 1
        fi

  # Run go vet
  vet:
    name: Go Vet
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.x'
        cache: true

    - name: Run go vet
      run: go vet ./...

  # Run tests on multiple platforms
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.x'
        cache: true

    - name: Download dependencies
      run: go mod download

    - name: Verify dependencies
      run: go mod verify

    - name: Run tests
      run: go test -v -race -count=1 ./...

    - name: Generate coverage
      if: matrix.os == 'ubuntu-latest'
      run: go test -coverprofile=coverage.out -covermode=atomic ./...

    - name: Upload coverage
      if: matrix.os == 'ubuntu-latest'
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.out
        flags: unittests
        fail_ci_if_error: false

  # Test ARM64-specific code
  test-arm64:
    name: Test ARM64 SIMD
    runs-on: macos-14  # Apple Silicon
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.x'
        cache: true

    - name: Verify ARM64
      run: |
        echo "Architecture: $(uname -m)"
        echo "GOARCH: $(go env GOARCH)"

    - name: Run SIMD tests
      run: go test -v -run=.*SIMD.* ./...

    - name: Run ARM64 tests
      run: go test -v -run=.*ARM64.* ./...

    - name: Run all tests with race detector
      run: go test -v -race ./...

  # Lint code
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.x'

    - name: golangci-lint
      uses: golangci/golangci-lint-action@v4
      with:
        version: latest
        args: --timeout=5m

  # Verify cross-platform builds
  build-matrix:
    name: Build (${{ matrix.os }}/${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        os: [linux, darwin, windows]
        arch: [amd64, arm64]
        exclude:
          - os: windows
            arch: arm64
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.x'
        cache: true

    - name: Build for ${{ matrix.os }}/${{ matrix.arch }}
      env:
        GOOS: ${{ matrix.os }}
        GOARCH: ${{ matrix.arch }}
      run: |
        echo "Building for $GOOS/$GOARCH..."
        go build -v ./...

  # Verify assembly code compiles
  verify-assembly:
    name: Verify Assembly
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.x'

    - name: Verify AMD64 assembly
      env:
        GOARCH: amd64
      run: |
        echo "Verifying AMD64 assembly..."
        go build -v ./internal/lookup/...
        go build -v ./internal/hash/...

    - name: Verify ARM64 assembly
      env:
        GOARCH: arm64
      run: |
        echo "Verifying ARM64 assembly..."
        go build -v ./internal/lookup/...
        go build -v ./internal/hash/...

  # Security scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.x'

    - name: Run Gosec
      uses: securego/gosec@v2.21.4
      with:
        args: '-no-fail ./...'

    - name: Run govulncheck
      run: |
        go install golang.org/x/vuln/cmd/govulncheck@latest
        govulncheck ./...

  # All checks must pass
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs:
      - format-check
      - vet
      - test
      - test-arm64
      - lint
      - build-matrix
      - verify-assembly
      - security
    steps:
    - name: Success
      run: echo "All CI checks passed!"
